# Smart Rain Monitor - Умный датчик дождя с уведомлениями в Telegram

Этот проект представляет собой устройство на базе ESP32, которое отслеживает наличие дождя и отправляет уведомления в Telegram.

## Описание

Устройство использует датчик дождя для определения наличия осадков. При обнаружении дождя, а также при его окончании, устройство отправляет уведомление в Telegram через Telegram Bot API. Устройство также использует NTP сервер для синхронизации времени, что позволяет указывать время начала дождя в уведомлениях.

## Функциональность

*   Обнаружение дождя с помощью датчика дождя.
*   Подключение к WiFi сети.
*   Синхронизация времени с NTP сервером.
*   Отправка уведомлений в Telegram при начале и окончании дождя.
*   Возможность отключения уведомлений в ночное время.
*   Настраиваемые параметры (WiFi SSID, пароль, Telegram Bot Token, Chat ID, время задержки для подтверждения дождя и т.д.).

## Алгоритм работы

1.  **Инициализация:**
    *   Подключение к WiFi сети.
    *   Инициализация датчика дождя в режиме `INPUT_PULLUP`.
    *   Подключение к NTP серверу и получение текущего времени.

2.  **Основной цикл:**
    *   **Чтение данных с датчика дождя:** Определяется, находится ли датчик в состоянии "мокро" или "сухо".
    *   **Обработка состояний:** Устройство переходит между различными состояниями в зависимости от показаний датчика дождя:
        *   `RAIN_STOPPED`: Дождя нет. Если датчик обнаруживает влагу, устройство переходит в состояние `RAIN_STARTING`.
        *   `RAIN_STARTING`: Ожидание подтверждения начала дождя. Если датчик остается мокрым в течение заданного времени (`rainThresholdTime`), устройство переходит в состояние `RAINING` и отправляет уведомление о начале дождя. Если датчик высыхает, устройство возвращается в состояние `RAIN_STOPPED`.
        *   `RAINING`: Дождь идет. Если датчик высыхает, устройство переходит в состояние `RAIN_STOPPING`.
        *   `RAIN_STOPPING`: Ожидание подтверждения окончания дождя. Если датчик остается сухим в течение заданного времени (`rainThresholdTime`), устройство переходит в состояние `RAIN_STOPPED` и отправляет уведомление об окончании дождя. Если датчик снова намокает, устройство возвращается в состояние `RAINING`.
    *   **Обновление времени с NTP сервера:** Время от времени устройство обновляет время с NTP сервера для поддержания точности.

3.  **Отправка уведомлений в Telegram:**
    *   Формирование текста сообщения с информацией о событии (начало или окончание дождя) и временем события.
    *   URL-кодирование текста сообщения для корректной передачи специальных символов.
    *   Отправка HTTP GET запроса к Telegram Bot API с использованием `WiFiClientSecure` для защищенного соединения.

## Необходимые компоненты

*   ESP32 плата
*   Датчик дождя (например, KY-038)
*   WiFi сеть
*   Учетная запись Telegram и Telegram Bot Token
*   Провода для подключения

## Схема подключения

Датчик дождя подключается к ESP32 следующим образом:

*   VCC датчика дождя к 3.3V ESP32
*   GND датчика дождя к GND ESP32
*   DO (Digital Output) датчика дождя к пину `rainSensorPin` (по умолчанию 4) ESP32

## Настройка

1.  Установите необходимые библиотеки в Arduino IDE:
    *   WiFi
    *   WiFiClientSecure
    *   NTPClient

2.  Отредактируйте следующие параметры в коде:
    *   `ssid`: Имя вашей WiFi сети.
    *   `password`: Пароль вашей WiFi сети.
    *   `telegramBotToken`: Токен вашего Telegram бота.  Получить его можно у BotFather в Telegram.
    *   `chatId`: ID чата, куда бот будет отправлять сообщения.  Чтобы узнать ID чата, отправьте любое сообщение своему боту и затем запросите информацию о чате через Telegram API (например, через браузер, выполнив запрос `https://api.telegram.org/botYOUR_BOT_TOKEN/getUpdates`).
    *   `rainSensorPin`: Пин, к которому подключен датчик дождя.
    *   `rainThresholdTime`: Время в миллисекундах, в течение которого датчик должен быть мокрым/сухим, чтобы подтвердить начало/окончание дождя.
    *   `timeOffsetSeconds`: Смещение времени для вашего часового пояса (в секундах).  Для Москвы это 10800 (UTC+3).
    *   `sendNightNotifications`: Отправлять уведомления ночью? (true - да, false - нет).

3.  Загрузите код на ESP32.

## Использование

После загрузки кода на ESP32, устройство автоматически подключится к WiFi и начнет отслеживать дождь. При обнаружении дождя, а также при его окончании, вы будете получать уведомления в Telegram.

## Предупреждения

*   Использование `client.setInsecure()` отключает проверку сертификата и небезопасно для production-проектов.  Для повышения безопасности необходимо настроить проверку сертификатов, но это требует более сложной настройки.
*   Убедитесь, что ваш датчик дождя подключен правильно и функционирует должным образом.
*   Проверьте правильность введенных параметров WiFi и Telegram.

